<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Alimentación - Lagos Andinos SRL</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/Pagina_web/CSS/style_alimentacion.css">
</head>
<body>
  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo"><i class="fas fa-fish"></i></div>
      <div class="company-name">Lagos Andinos</div>
      <div class="company-tagline">Sistema de Piscicultura</div>
    </div>
    <div class="nav-menu">
      <div class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-tachometer-alt"></i><span class="nav-text">Dashboard</span></a></div>
      <div class="nav-item"><a href="usuarios.html" class="nav-link"><i class="fas fa-users-cog"></i><span class="nav-text">Usuarios</span></a></div>
      <div class="nav-item"><a href="#" class="nav-link"><i class="fas fa-fish"></i><span class="nav-text">Lotes</span></a></div>
      <div class="nav-item"><a href="estanques.html" class="nav-link"><i class="fas fa-water"></i><span class="nav-text">Estanques</span></a></div>
      <div class="nav-item"><a href="especies.html" class="nav-link"><i class="fas fa-dna"></i><span class="nav-text">Especies</span></a></div>
      <div class="nav-item"><a href="alimentacion.html" class="nav-link active"><i class="fas fa-seedling"></i><span class="nav-text">Alimentación</span></a></div>
      <div class="nav-item"><a href="#" class="nav-link"><i class="fas fa-thermometer-half"></i><span class="nav-text">Parámetros Agua</span></a></div>
      <div class="nav-item"><a href="#" class="nav-link"><i class="fas fa-cut"></i><span class="nav-text">Cosecha</span></a></div>
      <div class="nav-item"><a href="#" class="nav-link"><i class="fas fa-chart-bar"></i><span class="nav-text">Reportes</span></a></div>
      <div class="nav-item"><a href="#" class="nav-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span class="nav-text">Cerrar Sesión</span></a></div>
    </div>
  </nav>
  <main class="main-content" id="mainContent">
    <div class="top-nav">
      <div class="top-nav-left">
        <button class="sidebar-toggle" onclick="toggleSidebar()" id="sidebarToggle"><i class="fas fa-bars"></i></button>
        <h1 class="page-title">Gestión de Alimentación</h1>
      </div>
      <div class="user-menu">
        <div class="user-info" id="userInfo">
          <div class="user-name">Carlos Rodriguez</div>
          <div class="user-role">Administrador</div>
        </div>
        <div class="user-avatar" id="userAvatar">CR</div>
      </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-card"><div class="stat-number" id="alimentacionHoy">0</div><div class="stat-label">Alimentaciones Hoy</div></div>
        <div class="stat-card"><div class="stat-number" id="totalAlimento">0</div><div class="stat-label">Kg Suministrados</div></div>
        <div class="stat-card"><div class="stat-number" id="lotesActivos">0</div><div class="stat-label">Lotes Activos</div></div>
        <div class="stat-card"><div class="stat-number" id="inventarioStock">0</div><div class="stat-label">Toneladas en Stock</div></div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <a href="#" class="action-card" onclick="showFeedingModal()">
          <div class="action-header"><div class="action-icon"><i class="fas fa-plus"></i></div><div class="action-title">Registrar Alimentación</div></div>
          <div class="action-description">Registra una nueva alimentación para un lote específico</div>
        </a>
        <a href="#" class="action-card" onclick="showFeedTypeModal()">
          <div class="action-header"><div class="action-icon"><i class="fas fa-seedling"></i></div><div class="action-title">Tipos de Alimento</div></div>
          <div class="action-description">Gestiona los tipos de alimento disponibles</div>
        </a>
        <a href="#" class="action-card" onclick="showInventoryModal()">
          <div class="action-header"><div class="action-icon"><i class="fas fa-boxes"></i></div><div class="action-title">Control de Inventario</div></div>
          <div class="action-description">Administra el stock de alimentos disponibles</div>
        </a>
        <a href="#" class="action-card" onclick="showScheduleModal()">
          <div class="action-header"><div class="action-icon"><i class="fas fa-calendar-alt"></i></div><div class="action-title">Programar Alimentación</div></div>
          <div class="action-description">Programa alimentaciones automáticas por horarios</div>
        </a>
      </div>

      <!-- Dashboard Cards -->
      <div class="dashboard-grid">
        <!-- Horario de Hoy -->
        <div class="dashboard-card">
          <div class="card-header">
            <div class="card-icon"><i class="fas fa-clock"></i></div>
            <div class="card-title"><h3>Horario de Hoy</h3><div class="card-subtitle">Alimentaciones programadas</div></div>
          </div>
          <div class="card-body"><div id="todaySchedule"><em class="text-muted">Sin programación</em></div></div>
        </div>

        <!-- Tipos de Alimento -->
        <div class="dashboard-card">
          <div class="card-header">
            <div class="card-icon"><i class="fas fa-seedling"></i></div>
            <div class="card-title"><h3>Tipos de Alimento</h3><div class="card-subtitle">Inventario disponible</div></div>
          </div>
          <div class="card-body"><div id="feedTypesSummary"><em class="text-muted">Sin datos</em></div></div>
        </div>

        <!-- Actividad Reciente -->
        <div class="dashboard-card">
          <div class="card-header">
            <div class="card-icon"><i class="fas fa-history"></i></div>
            <div class="card-title"><h3>Actividad Reciente</h3><div class="card-subtitle">Últimas alimentaciones</div></div>
          </div>
          <div class="card-body"><div id="recentFeedings"><em class="text-muted">Sin actividad</em></div></div>
        </div>
      </div>

      <!-- Registros de Alimentación -->
      <div class="data-container">
        <div class="data-header">
          <div class="data-title"><i class="fas fa-table"></i> Registros de Alimentación</div>
          <button class="btn btn-light" onclick="showFeedingModal()"><i class="fas fa-plus me-2"></i>Nuevo Registro</button>
        </div>

        <div class="data-body">
          <div class="filter-section">
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <label class="form-label">Buscar</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-search"></i></span>
                  <input type="text" class="form-control" id="searchInput" placeholder="Lote o tipo de alimento..."/>
                </div>
              </div>
              <div class="col-md-2">
                <label class="form-label">Fecha</label>
                <input type="date" class="form-control" id="dateFilter" value=""/>
              </div>
              <div class="col-md-2">
                <label class="form-label">Lote</label>
                <select class="form-select" id="loteFilter">
                  <option value="">Todos</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Tipo Alimento</label>
                <select class="form-select" id="feedTypeFilter">
                  <option value="">Todos</option>
                </select>
              </div>
              <div class="col-md-3">
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary" onclick="clearFilters()"><i class="fas fa-eraser me-1"></i>Limpiar</button>
                  <button class="btn btn-info" onclick="exportData()"><i class="fas fa-download me-1"></i>Exportar</button>
                </div>
              </div>
            </div>
          </div>

          <div class="table-container">
            <table class="table table-hover" id="feedingTable">
              <thead>
                <tr>
                  <th>Fecha/Hora</th>
                  <th>Lote</th>
                  <th>Tipo de Alimento</th>
                  <th>Cantidad (kg)</th>
                  <th>Frecuencia</th>
                  <th>Comportamiento</th>
                  <th>Registrado por</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="feedingTableBody">
                <tr>
                  <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-seedling fa-3x mb-3 d-block"></i>
                    No hay registros de alimentación disponibles
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </main>

  <!-- Modal: Registro de Alimentación -->
  <div class="modal fade" id="feedingModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Registrar Alimentación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="feedingForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Lote *</label>
              <select class="form-select" id="loteSelect" required>
                <option value="">Seleccionar lote...</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Tipo de Alimento *</label>
              <select class="form-select" id="tipoAlimentoSelect" required>
                <option value="">Seleccionar tipo...</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Fecha y Hora *</label>
              <input type="datetime-local" class="form-control" id="fechaAlimentacion" required/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Cantidad (kg) *</label>
              <input type="number" class="form-control" id="cantidadAlimento" min="0" step="0.001" required/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Frecuencia</label>
              <select class="form-select" id="frecuenciaSelect">
                <option value="">Seleccionar...</option>
                <option value="Mañana">Mañana</option>
                <option value="Mediodía">Mediodía</option>
                <option value="Tarde">Tarde</option>
                <option value="Múltiple">Múltiple</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Comportamiento</label>
              <select class="form-select" id="comportamientoSelect">
                <option value="">Seleccionar...</option>
                <option value="Normal">Normal</option>
                <option value="Activo">Activo</option>
                <option value="Pasivo">Pasivo</option>
                <option value="Agresivo">Agresivo</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Observaciones</label>
              <textarea class="form-control" id="observacionesAlimento" rows="3" placeholder="Observaciones adicionales..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="saveFeedingRecord()"><i class="fas fa-save me-1"></i>Guardar Registro</button>
      </div>
    </div></div>
  </div>

  <!-- Modal: Tipos de Alimento -->
  <div class="modal fade" id="feedTypeModal" tabindex="-1">
    <div class="modal-dialog modal-xl"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-seedling me-2"></i>Gestión de Tipos de Alimento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-4">
            <div class="card">
              <div class="card-header bg-light"><h6 class="mb-0">Nuevo Tipo de Alimento</h6></div>
              <div class="card-body">
                <form id="feedTypeForm">
                  <div class="mb-3">
                    <label class="form-label">Nombre *</label>
                    <input type="text" class="form-control" id="nombreTipoAlimento" required/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Presentación</label>
                    <select class="form-select" id="presentacionAlimento">
                      <option value="">Seleccionar...</option>
                      <option value="Granulado">Granulado</option>
                      <option value="Pellets">Pellets</option>
                      <option value="Concentrado">Concentrado</option>
                      <option value="Líquido">Líquido</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Frecuencia Destino</label>
                    <input type="text" class="form-control" id="frecDestinoAlimento" placeholder="Ej: 2-3 veces/día"/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Observaciones</label>
                    <textarea class="form-control" id="obsAlimento" rows="3"></textarea>
                  </div>
                  <button type="button" class="btn btn-primary w-100" onclick="saveFeedType()"><i class="fas fa-save me-1"></i>Guardar</button>
                </form>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="table-container">
              <table class="table table-hover">
                <thead><tr><th>Nombre</th><th>Presentación</th><th>Frecuencia</th><th>Acciones</th></tr></thead>
                <tbody id="feedTypesTableBody">
                  <tr><td colspan="4" class="text-center text-muted py-4">No hay tipos de alimento registrados</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div></div>
  </div>

  <!-- Modal: Inventario -->
  <div class="modal fade" id="inventoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-boxes me-2"></i>Control de Inventario de Alimentos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-4">
            <div class="card">
              <div class="card-header bg-light"><h6 class="mb-0">Registro de Movimiento</h6></div>
              <div class="card-body">
                <form id="inventoryForm">
                  <div class="mb-3">
                    <label class="form-label">Tipo de Alimento *</label>
                    <select class="form-select" id="tipoAlimentoInventario" required>
                      <option value="">Seleccionar...</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Tipo de Movimiento *</label>
                    <select class="form-select" id="tipoMovimiento" required>
                      <option value="">Seleccionar...</option>
                      <option value="ENTRADA">Entrada</option>
                      <option value="SALIDA">Salida</option>
                      <option value="AJUSTE">Ajuste</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Cantidad (kg) *</label>
                    <input type="number" class="form-control" id="cantidadInventario" min="0" step="0.001" required/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Fecha/Hora *</label>
                    <input type="datetime-local" class="form-control" id="fechaInventario" required/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Fecha de Vencimiento</label>
                    <input type="date" class="form-control" id="fechaVencimiento"/>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Observaciones</label>
                    <textarea class="form-control" id="obsInventario" rows="3"></textarea>
                  </div>
                  <button type="button" class="btn btn-primary w-100" onclick="saveInventoryRecord()"><i class="fas fa-save me-1"></i>Registrar Movimiento</button>
                </form>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6>Historial de Movimientos</h6>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshInventory()"><i class="fas fa-sync-alt me-1"></i>Actualizar</button>
              </div>
            </div>
            <div class="table-container">
              <table class="table table-hover table-sm">
                <thead><tr><th>Fecha</th><th>Tipo</th><th>Movimiento</th><th>Cantidad</th><th>Vencimiento</th><th>Acciones</th></tr></thead>
                <tbody id="inventoryTableBody">
                  <tr><td colspan="6" class="text-center text-muted py-4">No hay movimientos de inventario registrados</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div></div>
  </div>

  <!-- Modal: Programar Alimentación -->
  <div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-calendar-alt me-2"></i>Programar Alimentación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Esta funcionalidad estará disponible en futuras actualizaciones del sistema.</div>
        <form id="scheduleForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Lote</label>
              <select class="form-select" id="loteProgramacion" disabled><option value="">Seleccionar lote...</option></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Tipo de Alimento</label>
              <select class="form-select" id="alimentoProgramacion" disabled><option value="">Seleccionar tipo...</option></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Hora</label>
              <input type="time" class="form-control" id="horaProgramacion" disabled/>
            </div>
            <div class="col-md-4">
              <label class="form-label">Cantidad (kg)</label>
              <input type="number" class="form-control" id="cantidadProgramacion" min="0" step="0.001" disabled/>
            </div>
            <div class="col-md-4">
              <label class="form-label">Frecuencia</label>
              <select class="form-select" id="frecuenciaProgramacion" disabled>
                <option value="">Seleccionar...</option>
                <option value="Diaria">Diaria</option>
                <option value="Semanal">Semanal</option>
                <option value="Personalizada">Personalizada</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" disabled><i class="fas fa-calendar-plus me-1"></i>Programar</button>
      </div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ================================
       API endpoints (ajusta a tu backend)
       ================================ */
    const API = {
      stats: '/api/alimentacion/stats',
      lotes: '/api/lotes',
      tipos: '/api/tipos-alimento',
      registros: '/api/alimentacion/registros',     // ?q=&fecha=&lote=&tipo=
      recientes: '/api/alimentacion/recientes',
      horarioHoy: '/api/alimentacion/horario-hoy',
      invResumen: '/api/inventario/resumen-por-tipo',
      invMovs: '/api/inventario/movimientos',
      guardarRegistro: '/api/alimentacion/guardar',
      guardarTipoAlimento: '/api/tipos-alimento/guardar',
      guardarInventario: '/api/inventario/guardar'
    };

    /* ================================
       Estado + helpers
       ================================ */
    let STATE = { lotes: [], tipos: [], registros: [], invMovs: [] };
    const $ = id => document.getElementById(id);
    const fmtDate = s => s ? new Date(s).toLocaleDateString('es-ES') : '-';
    const fmtDateTime = s => s ? new Date(s).toLocaleString('es-ES',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit',year:'numeric'}) : '-';
    const badgeMov = t => t==='ENTRADA'?'success':(t==='SALIDA'?'danger':(t==='AJUSTE'?'warning':'secondary'));
    async function jget(url){ const r = await fetch(url); if(!r.ok) throw new Error(r.status); return r.json(); }
    async function jpost(url, body){
      const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(!r.ok) throw new Error(await r.text()); return r.json();
    }
    function notify(msg,type='info'){
      const n=document.createElement('div');
      n.className=`alert alert-${type==='error'?'danger':type} alert-dismissible fade show position-fixed`;
      n.style.cssText='top:20px;right:20px;z-index:9999;min-width:300px;';
      n.innerHTML=`${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
      document.body.appendChild(n); setTimeout(()=>n.remove(),5000);
    }

    /* ================================
       Init
       ================================ */
    document.addEventListener('DOMContentLoaded', init);
    async function init(){
      initializePage();
      await Promise.all([loadStats(), loadFilters()]);
      await Promise.all([loadTable(), loadSummaries(), loadInventoryTable()]);
      bindFilterEvents();
    }

    function initializePage(){
      const today = new Date().toISOString().split('T')[0];
      $('dateFilter').value = today;
      setNowDefaults();
    }
    function setNowDefaults(){
      const nowLocal = new Date(Date.now() - (new Date().getTimezoneOffset()*60000)).toISOString().slice(0,16);
      if($('fechaAlimentacion')) $('fechaAlimentacion').value = nowLocal;
      if($('fechaInventario')) $('fechaInventario').value = nowLocal;
    }

    /* ================================
       Stats
       ================================ */
    async function loadStats(){
      try{
        const s = await jget(API.stats);
        $('alimentacionHoy').textContent = s?.hoy ?? 0;
        $('totalAlimento').textContent  = s?.kg ?? 0;
        $('lotesActivos').textContent   = s?.lotesActivos ?? 0;
        $('inventarioStock').textContent= s?.stockTon ?? 0;
      }catch(e){ console.error(e); }
    }

    /* ================================
       Filtros (cargar selects)
       ================================ */
    async function loadFilters(){
      try{
        const [lotes, tipos] = await Promise.all([jget(API.lotes), jget(API.tipos)]);
        STATE.lotes = lotes || [];
        STATE.tipos = tipos || [];

        // Lotes
        ['loteFilter','loteSelect','loteProgramacion'].forEach(id=>{
          const el = $(id); if(!el) return;
          const first = (id==='loteFilter')?'<option value="">Todos</option>':'<option value="">Seleccionar lote...</option>';
          el.innerHTML = first + STATE.lotes.map(l=>`<option value="${l.id_lote}">${l.codigo_lote}${l.especie?(' - '+l.especie):''}</option>`).join('');
        });

        // Tipos
        ['feedTypeFilter','tipoAlimentoSelect','tipoAlimentoInventario','alimentoProgramacion'].forEach(id=>{
          const el = $(id); if(!el) return;
          const first = (id==='feedTypeFilter')?'<option value="">Todos</option>':'<option value="">Seleccionar tipo...</option>';
          el.innerHTML = first + STATE.tipos.map(t=>`<option value="${t.id_tipo_alimento}">${t.nombre}</option>`).join('');
        });

        renderFeedTypesTable();
      }catch(e){ console.error(e); }
    }

    /* ================================
       Tabla principal
       ================================ */
    async function loadTable(){
      const q = new URLSearchParams();
      const text = $('searchInput')?.value?.trim(); if(text) q.set('q', text);
      const fecha = $('dateFilter')?.value; if(fecha) q.set('fecha', fecha);
      const lote  = $('loteFilter')?.value; if(lote) q.set('lote', lote);
      const tipo  = $('feedTypeFilter')?.value; if(tipo) q.set('tipo', tipo);

      try{
        const data = await jget(`${API.registros}?${q.toString()}`);
        STATE.registros = data || [];
        renderFeedingTable();
      }catch(e){
        console.error(e);
        $('feedingTableBody').innerHTML = emptyRow(8,'No se pudo cargar la tabla');
      }
    }

    function renderFeedingTable(){
      const tbody = $('feedingTableBody');
      if(!STATE.registros.length){
        tbody.innerHTML = emptyRow(8,'No hay registros de alimentación disponibles');
        return;
      }
      tbody.innerHTML = STATE.registros.map(r=>`
        <tr>
          <td>${fmtDateTime(r.fecha)}</td>
          <td><span class="badge bg-primary">${r.codigo_lote ?? '-'}</span></td>
          <td>${r.tipo_alimento ?? '-'}</td>
          <td class="fw-bold text-success">${Number(r.cantidad).toFixed(3)} kg</td>
          <td>${r.frecuencia ? `<span class="frequency-badge freq-${(r.frecuencia||'').toLowerCase()}">${r.frecuencia}</span>` : '-'}</td>
          <td>${r.comportamiento ?? '-'}</td>
          <td>${r.registrado_por_nombre ?? '-'}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="viewRecord('${r.id_registro_alimentacion}')"><i class="fas fa-eye"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('${r.id_registro_alimentacion}')"><i class="fas fa-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }

    function emptyRow(cols,msg){
      return `<tr><td colspan="${cols}" class="text-center text-muted py-4"><i class="fas fa-seedling fa-3x mb-3 d-block"></i>${msg}</td></tr>`;
    }

    /* ================================
       Resúmenes (cards)
       ================================ */
    async function loadSummaries(){
      try{
        const [resInv, recientes, hoy] = await Promise.all([
          jget(API.invResumen),
          jget(API.recientes),
          jget(API.horarioHoy)
        ]);

        $('feedTypesSummary').innerHTML =
          (resInv||[]).map(t=>`
            <div class="feed-summary">
              <div class="feed-name">${t.nombre}</div>
              <div class="feed-stock">${Number(t.stock_kg ?? 0).toFixed(0)} kg</div>
            </div>
          `).join('') || '<em class="text-muted">Sin datos</em>';

        $('recentFeedings').innerHTML =
          (recientes||[]).map(r=>`
            <div class="activity-item">
              <div class="activity-icon"><i class="fas fa-utensils"></i></div>
              <div class="activity-content">
                <div class="activity-title">${fmtDateTime(r.fecha)} — ${r.codigo_lote ?? '-'}</div>
                <div class="activity-subtitle">${r.tipo_alimento ?? '-'} · ${Number(r.cantidad).toFixed(3)} kg</div>
              </div>
            </div>
          `).join('') || '<em class="text-muted">Sin actividad</em>';

        $('todaySchedule').innerHTML =
          (hoy||[]).map(h=>`
            <div class="schedule-item">
              <div class="schedule-time">${h.hora}</div>
              <div class="schedule-details">
                <div class="schedule-lote">${h.codigo_lote ?? '—'}</div>
                <div class="schedule-amount">${(h.cantidad_kg ?? 0)} kg${h.tipo ? ' - ' + h.tipo : ''}</div>
              </div>
            </div>
          `).join('') || '<em class="text-muted">Sin programación</em>';

      }catch(e){ console.error(e); }
    }

    /* ================================
       Inventario (modal)
       ================================ */
    async function loadInventoryTable(){
      try{
        const movs = await jget(API.invMovs);
        STATE.invMovs = movs || [];
        const tbody = $('inventoryTableBody');
        if(!STATE.invMovs.length){
          tbody.innerHTML = emptyRow(6,'No hay movimientos de inventario registrados');
          return;
        }
        tbody.innerHTML = STATE.invMovs.map(m=>`
          <tr>
            <td>${fmtDateTime(m.fecha)}</td>
            <td>${m.tipo_alimento ?? '-'}</td>
            <td><span class="badge bg-${badgeMov(m.tipo)}">${m.tipo}</span></td>
            <td class="fw-bold">${Number(m.cantidad).toFixed(3)} kg</td>
            <td>${m.fecha_vencimiento ? fmtDate(m.fecha_vencimiento) : '-'}</td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="deleteInventoryRecord('${m.id_inventario_alimentos}')"><i class="fas fa-trash"></i></button></td>
          </tr>
        `).join('');
      }catch(e){
        console.error(e);
        $('inventoryTableBody').innerHTML = emptyRow(6,'No se pudo cargar inventario');
      }
    }

    /* ================================
       Guardar (POST)
       ================================ */
    async function saveFeedingRecord(){
      const form = $('feedingForm');
      if(!form.checkValidity()){ form.reportValidity(); return; }
      const body = {
        id_lote: $('loteSelect').value || null,
        id_tipo_alimento: $('tipoAlimentoSelect').value || null,
        fecha: $('fechaAlimentacion').value,
        cantidad: $('cantidadAlimento').value,
        frecuencia: $('frecuenciaSelect').value || null,
        comportamiento: $('comportamientoSelect').value || null,
        observacion: $('observacionesAlimento').value || null
      };
      try{
        await jpost(API.guardarRegistro, body);
        notify('Registro de alimentación guardado','success');
        bootstrap.Modal.getInstance($('feedingModal')).hide();
        form.reset(); setNowDefaults();
        await Promise.all([loadTable(), loadStats(), loadSummaries()]);
      }catch(e){ notify('Error al guardar','error'); console.error(e); }
    }

    async function saveFeedType(){
      const nombre = $('nombreTipoAlimento').value.trim();
      if(!nombre){ notify('El nombre es requerido','error'); return; }
      const body = {
        nombre,
        presentacion: $('presentacionAlimento').value || null,
        frec_destino: $('frecDestinoAlimento').value || null,
        observacion: $('obsAlimento').value || null
      };
      try{
        await jpost(API.guardarTipoAlimento, body);
        notify('Tipo de alimento guardado','success');
        $('feedTypeForm').reset();
        await loadFilters();
      }catch(e){ notify('Error al guardar tipo de alimento','error'); console.error(e); }
    }

    async function saveInventoryRecord(){
      const form = $('inventoryForm');
      if(!form.checkValidity()){ form.reportValidity(); return; }
      const body = {
        id_tipo_alimento: $('tipoAlimentoInventario').value || null,
        tipo: $('tipoMovimiento').value,
        cantidad: $('cantidadInventario').value,
        fecha: $('fechaInventario').value,
        fecha_vencimiento: $('fechaVencimiento').value || null,
        observacion: $('obsInventario').value || null
      };
      try{
        await jpost(API.guardarInventario, body);
        notify('Movimiento registrado','success');
        form.reset(); setNowDefaults();
        await Promise.all([loadInventoryTable(), loadSummaries(), loadStats()]);
      }catch(e){ notify('Error al registrar movimiento','error'); console.error(e); }
    }

    /* ================================
       Render tabla de tipos (modal)
       ================================ */
    function renderFeedTypesTable(){
      const tbody = $('feedTypesTableBody');
      if(!STATE.tipos.length){
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">No hay tipos de alimento registrados</td></tr>`;
        return;
      }
      tbody.innerHTML = STATE.tipos.map(t=>`
        <tr>
          <td class="fw-bold">${t.nombre}</td>
          <td>${t.presentacion ?? '-'}</td>
          <td>${t.frec_destino ?? '-'}</td>
          <td>
            <!-- Botones listos para cuando implementes editar/eliminar en tu API -->
            <button class="btn btn-sm btn-outline-primary" disabled><i class="fas fa-edit"></i></button>
            <button class="btn btn-sm btn-outline-danger" disabled><i class="fas fa-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }

    /* ================================
       Acciones (placeholders)
       ================================ */
    function viewRecord(id){ /* abrir detalle si implementas endpoint */ }
    function deleteRecord(id){ /* DELETE /api/alimentacion/{id} y luego loadTable() */ }
    function deleteInventoryRecord(id){ /* DELETE /api/inventario/{id} y luego loadInventoryTable() */ }

    /* ================================
       Filtros / export
       ================================ */
    function bindFilterEvents(){
      $('searchInput')?.addEventListener('input', loadTable);
      $('dateFilter')?.addEventListener('change', loadTable);
      $('loteFilter')?.addEventListener('change', loadTable);
      $('feedTypeFilter')?.addEventListener('change', loadTable);
    }
    function clearFilters(){
      if($('searchInput')) $('searchInput').value = '';
      if($('dateFilter')) $('dateFilter').value = '';
      if($('loteFilter')) $('loteFilter').value = '';
      if($('feedTypeFilter')) $('feedTypeFilter').value = '';
      loadTable();
    }
    function exportData(){
      const q = new URLSearchParams();
      const text = $('searchInput')?.value?.trim(); if(text) q.set('q', text);
      const fecha = $('dateFilter')?.value; if(fecha) q.set('fecha', fecha);
      const lote  = $('loteFilter')?.value; if(lote) q.set('lote', lote);
      const tipo  = $('feedTypeFilter')?.value; if(tipo) q.set('tipo', tipo);
      window.location.href = '/api/alimentacion/export?' + q.toString();
    }

    /* ================================
       Sidebar responsive + logout
       ================================ */
    function toggleSidebar(){
      const sidebar = $('sidebar'); const main = $('mainContent');
      if (window.innerWidth <= 768){ sidebar.classList.toggle('show'); }
      else { sidebar.classList.toggle('collapsed'); main.classList.toggle('expanded'); }
    }
    window.addEventListener('resize', ()=>{
      const sidebar = $('sidebar'); const main = $('mainContent');
      if (window.innerWidth <= 768){ sidebar.classList.remove('collapsed'); main.classList.remove('expanded'); }
    });
    document.addEventListener('click', (e)=>{
      if (window.innerWidth <= 768){
        const sidebar = $('sidebar'); const toggle = $('sidebarToggle');
        if (!sidebar.contains(e.target) && e.target !== toggle && !toggle.contains(e.target)){ sidebar.classList.remove('show'); }
      }
    });
    function logout(){ if(confirm('¿Está seguro de cerrar sesión?')) location.href='login.html'; }
  </script>
</body>
</html>